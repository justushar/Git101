name: Enable Automerge and Sync Fork

on:
  pull_request:
    branches:
      - main

permissions:
  contents: write  # Give the GitHub Actions bot push access
  pull-requests: write  # Required to merge PRs
  workflows: write  # Required to update workflows

jobs:
  Enable-Automerge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'

      - name: Fetch Upstream and Sync Fork
        run: |
          # Add upstream remote to sync changes from the main repository
          git remote add upstream https://github.com/justushar/Git101.git

          # Fetch the latest changes from upstream main branch
          git fetch upstream

          # Checkout the PR branch (the branch that the PR is coming from)
          git checkout ${{ github.event.pull_request.head.ref }}

          # Rebase the PR branch on top of the latest upstream/main branch
          git rebase upstream/main || echo "Rebase encountered conflicts."

      - name: Resolve Merge Conflicts
        if: failure()  # This step only runs if the rebase failed due to conflicts
        run: |
          git status
          # Automatically resolve the conflict in `data.yaml` by keeping both changes
          git merge-file -p git-101/public/data.yaml git-101/public/data.yaml~upstream git-101/public/data.yaml || true

          # Mark conflicts as resolved and continue rebase
          git add git-101/public/data.yaml
          git rebase --continue

      - name: Force Push the Resolved Changes
        run: |
          # Push to the original remote branch of the PR
          git push origin HEAD:${{ github.event.pull_request.head.ref }} --force

      - name: Auto Merge PR
        run: |
          # Merge the PR automatically if all checks pass
          gh pr merge --auto --merge "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
